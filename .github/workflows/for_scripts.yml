name: Generate MikroTik RSC Files (Address-List + Routes)
on:
  schedule:
    - cron: "30 0 * * *" # 00:30 UTC
  workflow_dispatch:
permissions:
  contents: write
env:
  MAX_ENTRIES_PER_FILE: 350
  MAX_ENTRIES_PER_ROUTE_FILE: 100
  SITE_LIST: "amedia.site,anidub.pro,anilibria.tv,animego.org,animevost.org,bato.to,crunchyroll.com,jut.su,kara.su,kodik.info,mangahub.ru,mangapark.net,nyaa.land,nyaa.si,yummyanime.tv,danbooru.donmai.us,deviantart.com,ficbook.net,gelbooru.com,hentaichan.live,infinitenovel.eu,pixiv.net,rulate.ru,vndb.org,younettranslate.com,7k.casino,combotech,vavada.com,discord.com,discord.gg,discord.media,duolingo.com,grammarly.com,mrakopedia.net,refactoring.guru,wikiart.org,znanija.com,chess.com,itch.io,jetbrains.com,jetbrains%40cdn,jetbrains%40grazie.ai,messenger.com,signal.org,telegram.org,viber.com,whatsapp.com,zello.com,soundcloud.com,spotify.com,tidal.com,agents.media,agentura.ru,bbc.com,bellingcat.com,cherta.media,colta.ru,currenttime.tv,dept.one,doxa.team,dw.com,echofm.online,ehorussia.com,ej.ru,euronews.com,exler.ru,golosameriki.com,gordonua.com,gulagu.net,holod.media,hrw.org,istories.media,kasparov.ru,kavkaz-uzel.eu,korrespondent.net,krymr.com,meduza.io,memohrc.org,moscowtimes.ru,navalny.com,newtimes.ru,novayagazeta.ru,ovd.info,paperpaper.ru,polit.ru,proekt.media,prostovpn.org,radiosvoboda.org,semnasem.org,svoboda.org,tayga.info,the-village.ru,theins.ru,thetruestory.news,tvrain.ru,unian.net,verstka.media,vot-tak.tv,zona.media,beeg.com,hqporner.com,pornhub.com,pornolab.net,reddxxx.com,redgifs.com,redtube.com,rule34.xxx,xhamster.com,xhamsterlive.com,xnxx-ru.com,xvideos.com,babook.org,ralphlauren.eu,facebook.com,instagram.com,linkedin.com,patreon.com,quora.com,tiktok.com,x.com,10minutemail.com,aistudio.google.com,basecamp.com,bestchange.ru,canva.com,chatgpt.com,claude.ai,connect.garmin.com,copilot,deepl.com,elevenlabs.io,fmhy.net,grok.com,linktr.ee,make.com,medium.com,miro.com,naukri.com,notepad-plus-plus.org,notion.so,proton.me,proxyline.net,sentry.io,strava.com,trainingpeaks.com,tuta.com,whoop.com,zapier.com,1337x.to,booktracker.org,filmitorrent.net,freetp.org,kinozal.me,newstudio.tv,nnmclub.to,rustorka.com,rutor.info,rutracker.org,thepiratebay.org,torrent.by,daramalive.life,doramy.club,filmix.fm,hdrezka.ag,kino.pub,kinobase.org,kinovod.pro,kinozal.tv,lostfilm.tv,netflix.com,themoviedb.org,zeflix.online,youtube.com"
  CIDR4_URL_TEMPLATE: https://iplist.opencck.org/?format=text&data=cidr4&site={site}
  IP4_URL_TEMPLATE: https://iplist.opencck.org/?format=text&data=ip4&site={site}
jobs:
  generate-rsc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 1. CIDR4 → Address-List (iplistCIDRv4)
      # ========================================
      - name: Process CIDR4 → Address-List (iplistCIDRv4)
        run: |
          set -e
          IFS=',' read -ra site_array <<< "${{ env.SITE_LIST }}"
          CIDR4_URL_TEMPLATE="${{ env.CIDR4_URL_TEMPLATE }}"
          MAX="${{ env.MAX_ENTRIES_PER_FILE }}"
          OUTPUT_DIR="for_scripts/iplistCIDRv4"
          mkdir -p "$OUTPUT_DIR"

          gen_addr() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global AddressList"
              echo "/ip firewall address-list"
              for e in "$@"; do
                addr=${e#*:}
                echo ":do {add list=\$AddressList comment=$comment address=$addr} on-error {}"
              done
            } > "$out"
          }

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            cidr_url="${CIDR4_URL_TEMPLATE//\{site\}/$site}"
            curl -s -f "$cidr_url" > "input_cidr4_$site.txt" || continue

            cidrs=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' "input_cidr4_$site.txt" | sort -u)
            [ -z "$cidrs" ] && continue

            all_entries=()
            while IFS= read -r cidr; do all_entries+=("cidr:$cidr"); done <<< "$cidrs"
            count=${#all_entries[@]}

            if [ $count -le $MAX ]; then
              gen_addr "$OUTPUT_DIR/${site}.rsc" "$site" "${all_entries[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_entries[@]:idx:MAX}")
                gen_addr "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX))
                part=$((part + 1))
              done
            fi
          done

      # ========================================
      # 2. IP4 → Address-List (iplistv4)
      # ========================================
      - name: Process IP4 → Address-List (iplistv4)
        run: |
          set -e
          IFS=',' read -ra site_array <<< "${{ env.SITE_LIST }}"
          IP4_URL_TEMPLATE="${{ env.IP4_URL_TEMPLATE }}"
          MAX="${{ env.MAX_ENTRIES_PER_FILE }}"
          OUTPUT_DIR="for_scripts/iplistv4"
          mkdir -p "$OUTPUT_DIR"

          gen_addr() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global AddressList"
              echo "/ip firewall address-list"
              for e in "$@"; do
                addr=${e#*:}
                echo ":do {add list=\$AddressList comment=$comment address=$addr} on-error {}"
              done
            } > "$out"
          }

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            ip_url="${IP4_URL_TEMPLATE//\{site\}/$site}"
            curl -s -f "$ip_url" > "input_ip4_$site.txt" || continue

            ips=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$' "input_ip4_$site.txt" | sort -u)
            [ -z "$ips" ] && continue

            all_entries=()
            while IFS= read -r ip; do all_entries+=("ip:$ip"); done <<< "$ips"
            count=${#all_entries[@]}

            if [ $count -le $MAX ]; then
              gen_addr "$OUTPUT_DIR/${site}.rsc" "$site" "${all_entries[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_entries[@]:idx:MAX}")
                gen_addr "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX))
                part=$((part + 1))
              done
            fi
          done

      # ========================================
      # 3. MetaCubeX → ASN + GeoIP (address-list)
      # ========================================
      - name: Clone MetaCubeX
        run: git clone --depth 1 --branch meta https://github.com/MetaCubeX/meta-rules-dat.git

      - name: Process ASN + GeoIP → Address-List
        run: |
          set -e
          MAX="${{ env.MAX_ENTRIES_PER_FILE }}"
          REPO="meta-rules-dat"

          gen_addr() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global AddressList"
              echo "/ip firewall address-list"
              for e in "$@"; do
                a=${e#*:}
                echo ":do {add list=\$AddressList comment=$comment address=$a} on-error {}"
              done
            } > "$out"
          }

          process_dir() {
            local dir="$1" subdir="$2"
            OUTPUT_DIR="for_scripts/$subdir"
            mkdir -p "$OUTPUT_DIR"

            find "$REPO/$dir" -name "*.list" -type f | while read -r f; do
              resource=$(basename "$f" .list)
              cidrs=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' "$f" | sort -u)
              [ -z "$cidrs" ] && continue

              all_entries=()
              while IFS= read -r c; do all_entries+=("cidr:$c"); done <<< "$cidrs"
              count=${#all_entries[@]}

              if [ $count -le $MAX ]; then
                gen_addr "$OUTPUT_DIR/${resource}.rsc" "$resource" "${all_entries[@]}"
              else
                p=1; i=0
                while [ $i -lt $count ]; do
                  chunk=("${all_entries[@]:i:MAX}")
                  gen_addr "$OUTPUT_DIR/${resource}_part${p}.rsc" "$resource" "${chunk[@]}"
                  i=$((i + MAX))
                  p=$((p + 1))
                done
              fi
            done
          }

          process_dir "asn" "asnv4"
          process_dir "geo/geoip" "geoipv4"

      # ========================================
      # 4. Генерация маршрутов (100 per file)
      # ========================================
      - name: Generate Route Scripts (for_scripts_route/) — 100 per file
        run: |
          set -e
          MAX_ROUTE="${{ env.MAX_ENTRIES_PER_ROUTE_FILE }}"
          REPO="meta-rules-dat"

          gen_route() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global Distance"
              echo ":global RouteTab"
              echo ":global GateWay"
              echo "/ip route"
              for dst in "$@"; do
                echo ":if ([:len [/ip/route/find comment=$comment and dst-address=$dst]] = 0) do={ add dst-address=$dst gateway=\$GateWay routing-table=\$RouteTab distance=\$Distance comment=$comment }"
              done
            } > "$out"
          }

          # iplistCIDRv4 → route
          OUTPUT_DIR="for_scripts_route/iplistCIDRv4"
          mkdir -p "$OUTPUT_DIR"
          IFS=',' read -ra site_array <<< "${{ env.SITE_LIST }}"

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            file="input_cidr4_$site.txt"
            [ ! -f "$file" ] && continue
            cidrs=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' "$file" | sort -u)
            [ -z "$cidrs" ] && continue
            all_dst=()
            while IFS= read -r c; do all_dst+=("$c"); done <<< "$cidrs"
            count=${#all_dst[@]}

            if [ $count -le $MAX_ROUTE ]; then
              gen_route "$OUTPUT_DIR/${site}.rsc" "$site" "${all_dst[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_dst[@]:idx:MAX_ROUTE}")
                gen_route "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX_ROUTE))
                part=$((part + 1))
              done
            fi
          done

          # iplistv4 → route
          OUTPUT_DIR="for_scripts_route/iplistv4"
          mkdir -p "$OUTPUT_DIR"

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            file="input_ip4_$site.txt"
            [ ! -f "$file" ] && continue
            ips=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$' "$file" | sort -u)
            [ -z "$ips" ] && continue
            all_dst=()
            while IFS= read -r ip; do all_dst+=("$ip"); done <<< "$ips"
            count=${#all_dst[@]}

            if [ $count -le $MAX_ROUTE ]; then
              gen_route "$OUTPUT_DIR/${site}.rsc" "$site" "${all_dst[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_dst[@]:idx:MAX_ROUTE}")
                gen_route "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX_ROUTE))
                part=$((part + 1))
              done
            fi
          done

          # MetaCubeX → route
          process_route_dir() {
            local dir="$1" subdir="$2"
            OUTPUT_DIR="for_scripts_route/$subdir"
            mkdir -p "$OUTPUT_DIR"

            find "$REPO/$dir" -name "*.list" -type f | while read -r f; do
              resource=$(basename "$f" .list)
              cidrs=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' "$f" | sort -u)
              [ -z "$cidrs" ] && continue
              all_dst=()
              while IFS= read -r c; do all_dst+=("$c"); done <<< "$cidrs"
              count=${#all_dst[@]}

              if [ $count -le $MAX_ROUTE ]; then
                gen_route "$OUTPUT_DIR/${resource}.rsc" "$resource" "${all_dst[@]}"
              else
                p=1; i=0
                while [ $i -lt $count ]; do
                  chunk=("${all_dst[@]:i:MAX_ROUTE}")
                  gen_route "$OUTPUT_DIR/${resource}_part${p}.rsc" "$resource" "${chunk[@]}"
                  i=$((i + MAX_ROUTE))
                  p=$((p + 1))
                done
              fi
            done
          }

          process_route_dir "asn" "asnv4"
          process_route_dir "geo/geoip" "geoipv4"

      # ========================================
      # 5. Commit and push
      # ========================================
      - name: Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add for_scripts/ for_scripts_route/
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Auto-update: Address-List (350) + Routes (100 per file) → all sections" || exit 0
          git push